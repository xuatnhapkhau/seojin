<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Nhapkhautaicho Editor</title>
<style>
body { font-family: Arial; margin: 20px; max-width: 1500px; overflow-x:auto; }
table { width: 100%; border-collapse: collapse; table-layout: auto; }
th, td { border: 1px solid #ccc; padding: 6px; text-align: left; font-size: 12px; white-space: nowrap; }
input { width: 95%; padding:4px; box-sizing: border-box; font-size:12px; }
.actions { display:flex; gap:4px; }
button { padding:4px 8px; }
#searchInput { margin-bottom:12px; width:300px; padding:4px; }
.errorCell { border:2px solid red; }
</style>
</head>
<body>

<h2>Nhapkhautaicho Table Editor</h2>

<input type="text" id="searchInput" placeholder="Tìm kiếm..." />
<button id="btnReload">Tải dữ liệu</button>
<button id="btnAddNew">Thêm bản ghi mới</button>
<span id="msg"></span>

<div style="overflow-x:auto;">
<table>
  <thead>
    <tr id="thead"></tr>
  </thead>
  <tbody id="tbBody"></tbody>
</table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, get, push, update, remove, child } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

// -------- Firebase config --------
const firebaseConfig = {
  apiKey: "AIzaSyA1JFsENH4znr59Wy8CHBvQv9ViahS2FuQ",
  authDomain: "seojinmanage.firebaseapp.com",
  databaseURL: "https://seojinmanage-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "seojinmanage",
  storageBucket: "seojinmanage.firebasestorage.app",
  messagingSenderId: "900954568602",
  appId: "1:900954568602:web:2215438a2160dee5d52c23"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// -------- Cột thực tế --------
const columns = [
  "STT","MST_XK","Ten_XK","TKX_NO","TKX_LH","TKX_DATE","PXK_NO","PXK_DATE","VAT_NO","VAT_DATE",
  "TKX_TRIGIA","REMARK","REQUEST_LH_TKN","FOLDER_NAME","ENDDATE_TKN","TKN_NO","TKN_LH","TKN_DATE",
  "TKN_TRANGTHAI","DOC_RECEIVE","SUBJECT_MAILDOC","PIC_CARE","PIC_OPENCD","DONE_NOT"
];

const thead = document.getElementById('thead');
const tbBody = document.getElementById('tbBody');
const msg = document.getElementById('msg');

// tạo header
thead.innerHTML = columns.map(c=>`<th>${c}</th>`).join('') + '<th>Actions</th>';

// hiển thị msg
function showMsg(s,isError=false){ msg.textContent=s; msg.style.color=isError?'red':'#333'; setTimeout(()=>msg.textContent='',5000); }

// validate từng ô
function validateCell(column,value,inputElement){
  const dateCols = ["TKX_DATE","PXK_DATE","VAT_DATE","TKN_DATE","DOC_RECEIVE"];
  let valid = true, msg='';
  if(dateCols.includes(column) && value){
    if(!/^\d{2}\/\d{2}\/\d{4}$/.test(value)){
      valid=false; msg='Sai định dạng ngày dd/mm/yyyy';
    }
  }
  if(!valid){
    inputElement.classList.add('errorCell');
    inputElement.title = msg;
  }else{
    inputElement.classList.remove('errorCell');
    inputElement.title='';
  }
  return valid;
}

// tính cột tự động: ENDDATE_TKN, FOLDER_NAME
function computeAutoColumns(rowData){
  const tkxDateStr = rowData.TKX_DATE;
  if(tkxDateStr && /^\d{2}\/\d{2}\/\d{4}$/.test(tkxDateStr)){
    const parts = tkxDateStr.split('/');
    const dateObj = new Date(parts[2], parts[1]-1, parts[0]);
    // ENDDATE_TKN = TKX_DATE +15 ngày
    const endDate = new Date(dateObj); endDate.setDate(endDate.getDate()+15);
    rowData.ENDDATE_TKN = `${('0'+endDate.getDate()).slice(-2)}/${('0'+(endDate.getMonth()+1)).slice(-2)}/${endDate.getFullYear()}`;
    // FOLDER_NAME = dd.mm
    rowData.FOLDER_NAME = `${('0'+dateObj.getDate()).slice(-2)}.${('0'+(dateObj.getMonth()+1)).slice(-2)}`;
  }
}

// tính STT tự tăng
async function getNextSTT(){
  const snap = await get(child(ref(db),'Nhapkhautaicho'));
  if(!snap.exists()) return 1;
  const data = snap.val();
  const sttList = Object.values(data).map(u=>Number(u.STT)||0);
  return Math.max(...sttList)+1;
}

// load dữ liệu
async function loadData(){
  tbBody.innerHTML = '<tr><td colspan="'+(columns.length+1)+'">Đang tải...</td></tr>';
  try{
    const snapshot = await get(child(ref(db),'Nhapkhautaicho'));
    if(!snapshot.exists()){ tbBody.innerHTML='<tr><td colspan="'+(columns.length+1)+'">Không có dữ liệu</td></tr>'; return;}
    renderRows(snapshot.val());
    showMsg('Tải dữ liệu thành công.');
  }catch(err){ console.error(err); tbBody.innerHTML='<tr><td colspan="'+(columns.length+1)+'">Lỗi tải dữ liệu</td></tr>'; showMsg(err.message,true); }
}

// render rows
function renderRows(dataObj){
  tbBody.innerHTML='';
  Object.keys(dataObj).forEach(id=>{
    const rowData = dataObj[id];
    const tr = document.createElement('tr');
    columns.forEach(c=>{
      const td = document.createElement('td');
      td.textContent = rowData[c]??'';
      tr.appendChild(td);
    });
    const tdAct = document.createElement('td');
    const div = document.createElement('div'); div.className='actions';
    const btnEdit = document.createElement('button'); btnEdit.textContent='Edit';
    btnEdit.addEventListener('click',()=>enterEditMode(tr,id,rowData));
    const btnDelete = document.createElement('button'); btnDelete.textContent='Delete';
    btnDelete.addEventListener('click',()=>{
      if(!confirm('Xác nhận xóa?')) return;
      remove(ref(db,'Nhapkhautaicho/'+id)).then(()=>loadData()).catch(err=>{showMsg(err.message,true); console.error(err);});
    });
    div.appendChild(btnEdit); div.appendChild(btnDelete);
    tdAct.appendChild(div);
    tr.appendChild(tdAct);
    tbBody.appendChild(tr);
  });
}

// edit mode
function enterEditMode(tr,id,rowData){
  tr.innerHTML='';
  const inputs={};
  columns.forEach(c=>{
    const td = document.createElement('td');
    const inp = document.createElement('input'); inp.type='text'; inp.value=rowData[c]??'';
    inp.addEventListener('input',()=>validateCell(c,inp.value,inp));
    td.appendChild(inp); tr.appendChild(td);
    inputs[c]=inp;
  });

  const tdAct = document.createElement('td');
  const div = document.createElement('div'); div.className='actions';
  const btnSave = document.createElement('button'); btnSave.textContent='Save';
  const btnCancel = document.createElement('button'); btnCancel.textContent='Cancel';

  btnSave.addEventListener('click', async ()=>{
    // validate tất cả ô
    let allValid=true;
    columns.forEach(c=>{
      if(!validateCell(c,inputs[c].value,inputs[c])) allValid=false;
    });
    if(!allValid){ alert('Có ô sai định dạng, vui lòng sửa trước khi lưu!'); return; }

    const newData={};
    columns.forEach(c=>newData[c]=inputs[c].value);

    computeAutoColumns(newData);
    await update(ref(db,'Nhapkhautaicho/'+id),newData).then(()=>loadData()).catch(err=>{ showMsg(err.message,true); console.error(err); alert(err.message); });
  });
  btnCancel.addEventListener('click',loadData);
  div.appendChild(btnSave); div.appendChild(btnCancel);
  tdAct.appendChild(div);
  tr.appendChild(tdAct);
}

// thêm mới
document.getElementById('btnAddNew').addEventListener('click', async ()=>{
  const newData={};
  // STT tự tăng
  newData.STT = await getNextSTT();
  // các cột khác trống
  columns.forEach(c=>{ if(c!=='STT') newData[c]=''; });
  computeAutoColumns(newData);
  await push(ref(db,'Nhapkhautaicho'),newData).then(()=>loadData()).catch(err=>{ showMsg(err.message,true); console.error(err); });
});

// reload
document.getElementById('btnReload').addEventListener('click',loadData);

// tìm kiếm
const searchInput = document.getElementById('searchInput');
searchInput.addEventListener('input',()=>{
  const filter = searchInput.value.toLowerCase();
  const rows = tbBody.querySelectorAll('tr');
  rows.forEach(tr=>{
    const text = Array.from(tr.querySelectorAll('td')).map(td=>td.textContent.toLowerCase()).join(' ');
    tr.style.display = text.includes(filter)?'':'none';
  });
});

// load lần đầu
loadData();

</script>
</body>
</html>
