<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>C·∫≠p nh·∫≠t b·ªô ƒë·ªÅ thi ‚Äî Incremental IDs</title>
  <style>
    /* Reset v√† thi·∫øt l·∫≠p font c∆° b·∫£n */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 24px;
      background-color: #f4f6f9;
      color: #333;
    }
    
    /* Container ch√≠nh */
    .card {
      background: #ffffff;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      max-width: 900px;
      margin: 0 auto;
      border: 1px solid #e0e0e0;
    }
    
    h1 {
      font-size: 24px;
      margin: 0 0 20px;
      color: #1e3a8a; /* M√†u xanh ƒë·∫≠m */
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 10px;
    }

    h3 {
      font-size: 18px;
      margin: 20px 0 10px;
      color: #1e3a8a;
    }
    
    label {
      display: block;
      margin: 15px 0 8px;
      font-weight: 600;
      color: #4b5563;
    }
    
    /* Thi·∫øt l·∫≠p cho c√°c input, select, button */
    input[type="file"], input[type="text"], select {
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
      width: 100%;
      box-sizing: border-box;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    input[type="file"]:focus, input[type="text"]:focus, select:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
      outline: none;
    }
    
    button {
      padding: 10px 16px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.2s, opacity 0.2s;
      margin-right: 8px;
    }

    /* C√°c lo·∫°i n√∫t */
    #previewBtn {
      background-color: #10b981; /* Xanh l√° */
      color: white;
    }

    #previewBtn:hover {
      background-color: #059669;
    }

    #uploadBtn {
      background-color: #3b82f6; /* Xanh d∆∞∆°ng */
      color: white;
    }

    #uploadBtn:hover {
      background-color: #2563eb;
    }

    .template-btn {
      background-color: #f59e0b; /* V√†ng cam */
      color: white;
    }
    
    .template-btn:hover {
      background-color: #d97706;
    }

    /* V√πng Controls */
    .controls {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 10px;
    }

    .radio-group {
      display: flex;
      gap: 20px;
    }
    
    .radio-label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: normal;
      cursor: pointer;
    }

    /* V√πng Preview */
    #preview {
      margin-top: 20px;
      overflow-x: auto;
      max-height: 400px;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
      background-color: #f9fafb;
    }

    /* B·∫£ng */
    table {
      border-collapse: collapse;
      width: 100%;
      min-width: 600px;
    }
    
    th, td {
      border: 1px solid #e0e0e0;
      padding: 10px 12px;
      font-size: 14px;
      text-align: left;
    }

    th {
      background-color: #eef2ff; /* M√†u header b·∫£ng */
      font-weight: 700;
      color: #1e3a8a;
      position: sticky;
      top: 0;
    }
    
    /* C√°c ph·∫ßn t·ª≠ ph·ª• */
    .muted {
      color: #718096;
      font-size: 14px;
      margin-top: 10px;
    }
    
    .danger {
      color: #e53e3e;
      font-weight: 700;
    }
    
    hr {
      border: 0;
      border-top: 1px solid #e0e0e0;
      margin: 24px 0;
    }

    ul {
      list-style-type: disc;
      padding-left: 20px;
      margin-top: 5px;
    }

    li {
      margin-bottom: 8px;
    }

    #status {
      margin-left: 12px;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>üìù C·∫≠p nh·∫≠t b·ªô ƒë·ªÅ c√¢u h·ªèi tr·∫Øc nghi·ªám</h1>

    <label for="fileInput">Ch·ªçn file Excel (.xlsx, .xls, .csv)</label>
    <input id="fileInput" type="file" accept=".xlsx,.xls,.csv" />

    <div style="margin-top:15px" class="controls">
      <a id="downloadTemplate" href="Template_Update_BoDeThi.xlsx" download="Template_Update_BoDeThi.xlsx">
        <button class="template-btn">T·∫£i file template (.xlsx)</button>
      </a>
    </div>

    <div style="margin-top:20px">
      <label>‚öôÔ∏è Ch·ªçn Ch·∫ø ƒë·ªô C·∫≠p nh·∫≠t</label>
      <div class="radio-group">
        <label class="radio-label"><input id="treatmentReplace" name="mode" type="radio" value="replace" checked /> Thay th·∫ø d·ªØ li·ªáu c≈©</label>
        <label class="radio-label"><input id="treatmentAppend" name="mode" type="radio" value="append" /> C·∫≠p nh·∫≠t th√™m c√¢u h·ªèi</label>
      </div>
    </div>

    <div style="margin-top:20px" class="controls">
      <button id="previewBtn">üëÅÔ∏è Xem tr∆∞·ªõc d·ªØ li·ªáu</button>
      <button id="uploadBtn">üöÄ Upload l√™n Firestore</button>
      <span id="status" class="muted">Ch·ªù ch·ªçn file v√† b·∫•m Xem tr∆∞·ªõc.</span>
    </div>

    <div id="preview">
      <p class="muted">N·ªôi dung Excel s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y sau khi b·∫•m "Xem tr∆∞·ªõc d·ªØ li·ªáu".</p>
    </div>

    <hr/>

    <h3>üí° Quy t·∫Øc X·ª≠ l√Ω D·ªØ li·ªáu</h3>
    <ul>
	<li>Upload v√†o Collection *questions* tr√™n Firebase.</li>
      <li>D√≤ng 1 c·ªßa Excel l√† t√™n c·ªôt s·∫Ω kh√¥ng ƒë∆∞·ª£c upload v√†o Firestore.</li>
      <li>N·∫øu ch·ªçn *Thay th·∫ø d·ªØ li·ªáu c≈©*: Collection *questions* s·∫Ω b·ªã x√≥a ho√†n to√†n tr∆∞·ªõc khi upload; ID t√†i li·ªáu s·∫Ω b·∫Øt ƒë·∫ßu t·ª´ 1.</li>
      <li>N·∫øu ch·ªçn *C·∫≠p nh·∫≠t th√™m c√¢u h·ªèi*: Ch∆∞∆°ng tr√¨nh s·∫Ω t√¨m ID s·ªë l·ªõn nh·∫•t hi·ªán c√≥ v√† c·∫•p ID ti·∫øp theo t·ª´ ƒë√≥ ƒë·ªÉ tr√°nh tr√πng l·∫∑p.</li>
      <li>C·ªôt A (M√£ m√¥n thi) ph·∫£i l√† d·∫°ng s·ªë. N·∫øu ph√°t hi·ªán gi√° tr·ªã kh√¥ng ph·∫£i s·ªë s·∫Ω c·∫£nh b√°o v√† d·ª´ng upload.</li>
    </ul>
    <p class="muted">L∆∞u √Ω: N·∫øu collection c√≥ k√≠ch th∆∞·ªõc l·ªõn, th·ªùi gian *C·∫≠p nh·∫≠t th√™m c√¢u h·ªèi* c√≥ th·ªÉ t·ªën nhi·ªÅu th·ªùi gian ƒë·ªÉ t√¨m ID l·ªõn nh·∫•t.</p>
  </div>

  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
  
  <script type="module">
const firebaseConfig = {

  apiKey: "AIzaSyDsAHlo0GxEJJzUJJqeh66AX2L_-_oLyy0",

  authDomain: "thinghiepvuhq.firebaseapp.com",

  projectId: "thinghiepvuhq",

  storageBucket: "thinghiepvuhq.firebasestorage.app",

  messagingSenderId: "523444944172",

  appId: "1:523444944172:web:13c618967461eeb75ac089",

  measurementId: "G-FXJ4MXCBGX"

};


    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getFirestore, collection, doc, writeBatch, getDocs } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const fileInput = document.getElementById('fileInput');
    const previewBtn = document.getElementById('previewBtn');
    const uploadBtn = document.getElementById('uploadBtn');
    const previewEl = document.getElementById('preview');
    const status = document.getElementById('status');
    const treatmentReplace = document.getElementById('treatmentReplace');
    const treatmentAppend = document.getElementById('treatmentAppend');
    const downloadTemplate = document.getElementById('downloadTemplate'); // Bi·∫øn m·ªõi cho n√∫t t·∫£i template

    let lastJson = null;

    // ƒê·∫£m b·∫£o t√™n file template l√† 'Template_Update_BoDeThi.xlsx'
    downloadTemplate.href = 'Template_Update_BoDeThi.xlsx';
    downloadTemplate.setAttribute('download', 'Template_Update_BoDeThi.xlsx');


    function readExcelFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = e.target.result;
            const workbook = XLSX.read(data, {type: 'array'});
            const firstSheetName = workbook.SheetNames[0];
            const sheet = workbook.Sheets[firstSheetName];
            const json = XLSX.utils.sheet_to_json(sheet, {defval: null});
            const headers = workbook.Sheets[firstSheetName] ? XLSX.utils.sheet_to_json(sheet, {header:1})[0] : [];
            resolve({json, sheetName: firstSheetName, headers});
          } catch (err) { reject(err); }
        };
        reader.onerror = reject;
        reader.readAsArrayBuffer(file);
      });
    }

    function renderPreview(json, headers, maxRows=50) {
      if (!json || !Array.isArray(json) || json.length === 0) return previewEl.innerHTML = '<p class="muted" style="padding: 15px;">Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã.</p>';
      const keys = headers && headers.length ? headers : Object.keys(json[0] || {});
      const rows = json.slice(0, maxRows);
      let html = '<table><thead><tr>' + keys.map(k => `<th>${k}</th>`).join('') + '</tr></thead><tbody>';
      for (const r of rows) {
        html += '<tr>' + keys.map(k => `<td>${(r[k]===null||r[k]===undefined)?'':escapeHtml(String(r[k]))}</td>`).join('') + '</tr>';
      }
      html += '</tbody></table>';
      if (json.length > maxRows) html += `<p class="muted" style="padding: 10px 15px;">Hi·ªÉn th·ªã ${maxRows}/${json.length} d√≤ng.</p>`;
      previewEl.innerHTML = html;
    }

    function escapeHtml(s){ return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    previewBtn.addEventListener('click', async () => {
      const f = fileInput.files[0];
      if (!f) return alert('Vui l√≤ng ch·ªçn file Excel tr∆∞·ªõc.');
      status.textContent = 'ƒêang ƒë·ªçc file...';
      try {
        const {json, sheetName, headers} = await readExcelFile(f);
        lastJson = {rows: json, headers};
        renderPreview(json, headers);
        status.textContent = `‚úÖ ƒê√£ ƒë·ªçc ${json.length} d√≤ng (sheet: ${sheetName}). D√≤ng 1 ƒë∆∞·ª£c coi l√† header.`;
      } catch (err) {
        console.error(err); status.textContent = '‚ùå L·ªói ƒë·ªçc file: ' + err.message;
      }
    });

    async function findMaxNumericDocId(collectionName) {
      status.textContent = 'üîç ƒêang t√¨m ID s·ªë l·ªõn nh·∫•t trong collection... (c√≥ th·ªÉ m·∫•t th·ªùi gian)';
      const colRef = collection(db, collectionName);
      const snapshot = await getDocs(colRef);
      let max = 0;
      snapshot.forEach(d => {
        const id = d.id;
        if (/^-?\d+$/.test(id)) {
          const n = parseInt(id, 10);
          if (!isNaN(n) && n > max) max = n;
        }
      });
      status.textContent = `‚úÖ ID l·ªõn nh·∫•t t√¨m ƒë∆∞·ª£c: ${max}`;
      return max;
    }

    async function clearCollection(collectionName) {
      status.textContent = 'üóëÔ∏è ƒêang x√≥a d·ªØ li·ªáu c≈©...';
      const colRef = collection(db, collectionName);
      const snapshot = await getDocs(colRef);
      if (snapshot.empty) {
        status.textContent = '‚úÖ Kh√¥ng c√≥ t√†i li·ªáu c≈© ƒë·ªÉ x√≥a.';
        return;
      }
      const docs = snapshot.docs;
      const { writeBatch } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js');
      let batch = writeBatch(db);
      let cnt = 0;
      let total = 0;
      for (const d of docs) {
        batch.delete(d.ref);
        cnt++; total++;
        if (cnt >= 499) { await batch.commit(); batch = writeBatch(db); cnt = 0; status.textContent = `üóëÔ∏è ƒê√£ x√≥a ${total} t√†i li·ªáu...`; }
      }
      if (cnt > 0) await batch.commit();
      status.textContent = `‚úÖ X√≥a ho√†n t·∫•t: ${total} t√†i li·ªáu ƒë√£ b·ªã x√≥a.`;
    }

    uploadBtn.addEventListener('click', async () => {
      if (!lastJson) return alert('Ch∆∞a c√≥ d·ªØ li·ªáu. Vui l√≤ng b·∫•m "Xem tr∆∞·ªõc d·ªØ li·ªáu" tr∆∞·ªõc khi upload.');
      
      if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën th·ª±c hi·ªán ${treatmentReplace.checked ? 'THAY TH·∫æ (X√ìA & GHI M·ªöI)' : 'C·∫¨P NH·∫¨T TH√äM'} d·ªØ li·ªáu l√™n Firestore?`)) return;

      const collectionName = 'questions';	//T√™n database tr√™n Firebase
      const mode = treatmentReplace.checked ? 'replace' : 'append';
      const rows = lastJson.rows;
      const headers = lastJson.headers || Object.keys(rows[0] || {});
      
      if (rows.length === 0) return alert('File kh√¥ng c√≥ d√≤ng d·ªØ li·ªáu n√†o ngo√†i header.');

      const firstColName = headers[0];

      // Validate column A numeric
      const nonNumericRows = [];
      for (let i=0;i<rows.length;i++){
        const v = rows[i][firstColName];
        // Ch·ªâ ch·∫•p nh·∫≠n s·ªë ho·∫∑c null/undefined. N·∫øu c√≥ gi√° tr·ªã, ph·∫£i l√† s·ªë.
        if (v !== null && v !== undefined && String(v).trim() !== ''){ 
          const num = Number(String(v).replace(/,/g,'').trim());
          if (Number.isNaN(num)) nonNumericRows.push({row:i+2,value:v});
        }
      }
      if (nonNumericRows.length>0){
        const sample = nonNumericRows.slice(0,5).map(x=>`D√≤ng ${x.row}: "${x.value}"`).join('\n');
        return alert('‚ùå Ph√°t hi·ªán gi√° tr·ªã KH√îNG PH·∫¢I S·ªê trong c·ªôt A (M√£ M√¥n/Tr∆∞·ªùng ƒë·∫ßu ti√™n):\n'+sample+'\nVui l√≤ng s·ª≠a file Excel.');
      }

      try {
        let startId = 1;
        if (mode === 'append') {
          const max = await findMaxNumericDocId(collectionName);
          startId = max + 1;
        }
        if (mode === 'replace') {
          await clearCollection(collectionName);
          startId = 1;
        }

        status.textContent = '‚è≥ B·∫Øt ƒë·∫ßu upload d·ªØ li·ªáu...';
        const { writeBatch } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js');
        let batch = writeBatch(db);
        const BATCH_LIMIT = 499; // Gi·ªõi h·∫°n batch l√† 500, d√πng 499 ƒë·ªÉ an to√†n
        let cnt=0; let total=0; let currentId=startId;

        for (let i=0;i<rows.length;i++){
          const r=rows[i];
          const docData={};
          for (let j=0;j<headers.length;j++){
            const key=headers[j];
            const val=r[key];
            
            // X·ª≠ l√Ω c·ªôt A (ƒë·∫ßu ti√™n) l√† s·ªë, c√°c c·ªôt c√≤n l·∫°i l√† chu·ªói (ho·∫∑c null)
            docData[key]= (j===0) ? (val===null||val===undefined||String(val).trim()===''? null : Number(String(val).replace(/,/g,'').trim()))
                                   : (val===null||val===undefined?null:String(val));
          }
          const docRef = doc(collection(db, collectionName), String(currentId));
          batch.set(docRef, docData);
          currentId++; cnt++; total++;
          if (cnt>=BATCH_LIMIT){ await batch.commit(); batch=writeBatch(db); cnt=0; status.textContent=`‚è≥ ƒê√£ upload ${total} b·∫£n ghi...`;}
        }
        if(cnt>0) await batch.commit();
        status.textContent=`üéâ Ho√†n t·∫•t upload: ${total} b·∫£n ghi (ID b·∫Øt ƒë·∫ßu t·ª´ ${startId}).`;
        alert('Upload ho√†n t·∫•t.');
      } catch(err){ 
        console.error(err); 
        status.textContent='‚ùå L·ªói trong qu√° tr√¨nh upload: '+err.message; 
        alert('L·ªói: '+err.message);
      }
    });
  </script>
</body>
</html>