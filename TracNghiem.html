<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>√în t·∫≠p tr·∫Øc nghi·ªám</title>
  <style>
    /* ------------------------------------- */
    /* CSS: Giao di·ªán hi·ªán ƒë·∫°i */
    /* ------------------------------------- */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0; 
      padding: 0;
      background-color: #f4f6f9;
      color: #333;
    }
    
    .card {
      background: #ffffff;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      max-width: 900px;
      /* ƒê·∫∑t margin chung cho c√°c card */
      margin: 20px auto; 
      border: 1px solid #e0e0e0;
    }

    /* THAY ƒê·ªîI: Kh√¥ng c·∫ßn ƒë·∫©y card ƒë·∫ßu ti√™n xu·ªëng v√¨ kh√¥ng c√≤n header c·ªë ƒë·ªãnh */
    .card:first-of-type {
        margin-top: 20px; 
    }
    
    h1 {
      font-size: 24px;
      margin: 0 0 20px;
      color: #1e3a8a;
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 10px;
    }
    
    label {
      display: block;
      margin: 15px 0 8px;
      font-weight: 600;
      color: #4b5563;
    }
    
    select, button {
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      transition: background-color 0.2s, opacity 0.2s;
      cursor: pointer;
    }

    select {
        width: 100%;
        max-width: 300px;
        display: inline-block;
    }

    .controls {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
    }

    /* X√ìA CSS LI√äN QUAN ƒê·∫æN HEADER V√Ä LOGO */

    /* Styles cho c√°c n√∫t ƒëi·ªÅu h∆∞·ªõng */
    #loadQuestionsBtn {
        background-color: #059669; /* Xanh l√° */
        color: white;
        border: none;
    }

    #loadQuestionsBtn:hover { background-color: #047857; }

    .nav-btn {
        background-color: #3b82f6; /* Xanh d∆∞∆°ng */
        color: white;
        border: none;
    }

    .nav-btn:hover:not(:disabled) { background-color: #2563eb; }
    .nav-btn.limit { opacity: 0.7; cursor: not-allowed; } 

    #answerBtn {
        background-color: #f97316; /* Cam */
        color: white;
        border: none;
        font-weight: 700;
    }
    #answerBtn:hover:not(:disabled) { background-color: #ea580c; }
    
    #questionContainer {
        margin-top: 20px;
        padding: 20px;
        border: 1px solid #e0e0e0;
        border-radius: 12px;
        background-color: #f9fafb;
    }
    
    #statsDisplay { /* Th·ªëng k√™ */
        font-size: 16px;
        font-weight: 700;
        padding-bottom: 10px;
        border-bottom: 1px dashed #ccc;
        margin-bottom: 20px;
    }

    /* CSS CHO C√ÇU H·ªéI (N·ªïi b·∫≠t) */
    .question-text {
        font-size: 22px; 
        font-weight: 900; 
        color: #007bff; 
        margin-bottom: 15px;
    }
    
    .answer-option {
        display: flex;
        align-items: flex-start;
        margin-bottom: 10px;
        cursor: pointer;
        padding: 12px;
        border-radius: 8px;
        border: 1px solid #eee;
        background-color: #ffffff;
        transition: background-color 0.2s;
    }

    .answer-option:hover {
        background-color: #eff6ff;
    }

    .answer-option input[type="checkbox"] {
        margin-right: 15px;
        margin-top: 4px; 
        transform: scale(1.2);
    }

    #feedback {
        margin-top: 20px;
        padding: 15px;
        border-radius: 8px;
        font-weight: 600;
        display: none; 
    }

    .feedback-correct {
        background-color: #ecfdf5; 
        border: 1px solid #10b981;
        color: #065f46;
    }

    .feedback-incorrect {
        background-color: #fff7ed; 
        border: 1px solid #f97316;
        color: #9a3412;
    }

    .note-text {
        margin-top: 10px;
        font-weight: 400;
        border-top: 1px dashed #ccc;
        padding-top: 10px;
    }
    
    #status {
        font-style: italic;
        color: #718096;
    }

    .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3b82f6;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-right: 8px;
        vertical-align: middle;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  
  <div class="card">
    <h1>üìù √în T·∫≠p Tr·∫Øc Nghi·ªám</h1>

    <div class="controls">
      <label for="subjectSelector" style="margin-top:0; margin-bottom:0;">Ch·ªçn M√¥n Thi:</label>
    </div>
    <div style="margin-top:5px" class="controls">
      <select id="subjectSelector">
        //<option value="">-- ƒêang t·∫£i M√£ M√¥n --</option>
      </select>
      <button id="loadQuestionsBtn">T·∫£i B·ªô ƒê·ªÅ</button>
    </div>
    <span id="status" style="margin-top:10px; display:block;"></span>
  </div>

  <div class="card" id="questionCard" style="display:none;">
    <div id="statsDisplay"></div> 
    <div id="subjectNameDisplay"></div> 
    <div id="questionContainer"></div>

    <div id="feedback" style="display:none;"></div>

    <hr style="margin:20px 0;">

    <div class="controls">
        <button id="prevBtn" class="nav-btn limit">‚Ü©Ô∏è C√¢u h·ªèi tr∆∞·ªõc</button>
        <button id="answerBtn">‚ùì Tr·∫£ l·ªùi</button>
        <button id="nextBtn" class="nav-btn">C√¢u h·ªèi ti·∫øp theo ‚û°Ô∏è</button>
    </div>
  </div>

  <script type="module">
    // ‚ö†Ô∏è B∆Ø·ªöC 1: THAY TH·∫æ C√ÅC TH√îNG S·ªê N√ÄY B·∫∞NG TH√îNG TIN D·ª∞ √ÅN C·ª¶A B·∫†N
    const firebaseConfig = {

  apiKey: "AIzaSyDsAHlo0GxEJJzUJJqeh66AX2L_-_oLyy0",

  authDomain: "thinghiepvuhq.firebaseapp.com",

  projectId: "thinghiepvuhq",

  storageBucket: "thinghiepvuhq.firebasestorage.app",

  messagingSenderId: "523444944172",

  appId: "1:523444944172:web:13c618967461eeb75ac089",

  measurementId: "G-FXJ4MXCBGX"

};


    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getFirestore, collection, getDocs, query, where } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const COLLECTION_NAME = 'questions'; 

    // B∆Ø·ªöC 2: KHAI B√ÅO C√ÅC T√äN TR∆Ø·ªúNG C·ªê ƒê·ªäNH
    const MA_MON_FIELD_NAME = 'MA_MON';
    const QUESTION_TEXT_FIELD = 'CAU_HOI';
    const OPTION_A_FIELD = 'DAPAN_A';
    const OPTION_B_FIELD = 'DAPAN_B';
    const OPTION_C_FIELD = 'DAPAN_C';
    const OPTION_D_FIELD = 'DAPAN_D';
    const CORRECT_ANSWER_FIELD = 'DAPAN_DUNG'; 
    const NOTE_FIELD = 'GHI_CHU';             

    // Gi·ªõi h·∫°n quay l·∫°i l·ªãch s·ª≠
    const HISTORY_LIMIT = 3; 

    // DOM Elements
    const subjectSelector = document.getElementById('subjectSelector');
    const loadQuestionsBtn = document.getElementById('loadQuestionsBtn');
    const questionCard = document.getElementById('questionCard');
    const questionContainer = document.getElementById('questionContainer');
    const feedbackEl = document.getElementById('feedback');
    const statusEl = document.getElementById('status');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const answerBtn = document.getElementById('answerBtn');
    const statsDisplay = document.getElementById('statsDisplay'); // DOM cho th·ªëng k√™
    const subjectNameDisplay = document.getElementById('subjectNameDisplay'); 

    // Global State
    let allQuestionsForSubject = []; 
    let historyStack = [];           
    let currentHistoryIndex = -1;    
    let isAnswered = false;          
    let stats = { correct: 0, incorrect: 0, totalAnswered: 0 }; // TR·∫†NG TH√ÅI TH·ªêNG K√ä M·ªöI

    // -----------------------------------------------------
    // PH·∫¶N 1: T·∫¢I V√Ä X·ª¨ L√ù D·ªÆ LI·ªÜU
    // -----------------------------------------------------
    
    // B·ªî SUNG: Danh s√°ch m√£ m√¥n c·ªë ƒë·ªãnh ƒë·ªÉ t√¨m t√™n m√¥n
    const SUBJECT_LIST = [
        { code: 11, name: 'PH√ÅP LU·∫¨T H·∫¢I QUAN - Ph√°p lu·∫≠t HQ' },
        { code: 12, name: 'PH√ÅP LU·∫¨T H·∫¢I QUAN - Ch√≠nh s√°ch thu·∫ø' },
        { code: 13, name: 'PH√ÅP LU·∫¨T H·∫¢I QUAN - Vi ph·∫°m h√†nh ch√≠nh' },
        { code: 21, name: 'K·ª∏ THU·∫¨T NGHI·ªÜP V·ª§ NGO·∫†I TH∆Ø∆†NG - Giao nh·∫≠n v·∫≠n t·∫£i' },
        { code: 22, name: 'K·ª∏ THU·∫¨T NGHI·ªÜP V·ª§ NGO·∫†I TH∆Ø∆†NG - Ngo·∫°i th∆∞∆°ng' },
        { code: 23, name: 'K·ª∏ THU·∫¨T NGHI·ªÜP V·ª§ NGO·∫†I TH∆Ø∆†NG - Thanh to√°n qu·ªëc t·∫ø' },
        { code: 31, name: 'K·ª∏ THU·∫¨T NGHI·ªÜP V·ª§ H·∫¢I QUAN - Th·ªß t·ª•c h·∫£i quan' },
        { code: 32, name: 'K·ª∏ THU·∫¨T NGHI·ªÜP V·ª§ H·∫¢I QUAN - Ch√≠nh s√°ch m·∫∑t h√†ng' },
        { code: 33, name: 'K·ª∏ THU·∫¨T NGHI·ªÜP V·ª§ H·∫¢I QUAN - Tr·ªã gi√° h·∫£i quan' },
        { code: 34, name: 'K·ª∏ THU·∫¨T NGHI·ªÜP V·ª§ H·∫¢I QUAN - Xu·∫•t x·ª© h√†ng h√≥a' },
        { code: 35, name: 'K·ª∏ THU·∫¨T NGHI·ªÜP V·ª§ H·∫¢I QUAN - S·ª° h·ªØu tr√≠ tu·ªá' },
        { code: 36, name: 'K·ª∏ THU·∫¨T NGHI·ªÜP V·ª§ H·∫¢I QUAN - Ph√¢n lo·∫°i h√†ng h√≥a' },
    ];
    
    // B·ªî SUNG: H√†m t√¨m t√™n m√¥n h·ªçc d·ª±a tr√™n m√£ m√¥n
    function getSubjectName(code) {
        const subject = SUBJECT_LIST.find(s => String(s.code) === String(code));
        return subject ? subject.name : `M√£ m√¥n ${code}`;
    }


    async function loadSubjects() {
      // Logic t·∫£i m√£ m√¥n ƒë∆∞·ª£c gi·ªØ nguy√™n
      statusEl.innerHTML = '<span class="loading-spinner"></span> ƒêang t·∫£i danh s√°ch m√£ m√¥n...';
      subjectSelector.innerHTML = '<option value="">-- ƒêang t·∫£i... --</option>';
      try {
        const colRef = collection(db, COLLECTION_NAME);
        const snapshot = await getDocs(colRef); 
        const allSubjects = new Set();
        snapshot.forEach(doc => {
          const data = doc.data();
          if (data[MA_MON_FIELD_NAME] !== null && data[MA_MON_FIELD_NAME] !== undefined) {
            allSubjects.add(String(data[MA_MON_FIELD_NAME]).trim()); 
          }
        });
        subjectSelector.innerHTML = '<option value="">-- Ch·ªçn M√£ M√¥n --</option>';

        Array.from(allSubjects).sort().forEach(subjectCode => {
            const subjectName = getSubjectName(subjectCode);
            const option = document.createElement('option');
            option.value = subjectCode;
            option.textContent = `${subjectCode} - ${subjectName}`; 
            subjectSelector.appendChild(option);
        });
        statusEl.textContent = `‚úÖ ƒê√£ t·∫£i ${allSubjects.size} m√£ m√¥n.`;
      } catch (error) {
        console.error("L·ªói khi t·∫£i m√£ m√¥n:", error);
        statusEl.textContent = '‚ùå L·ªói khi t·∫£i m√£ m√¥n: ' + error.message;
        subjectSelector.innerHTML = '<option value="">-- L·ªói t·∫£i d·ªØ li·ªáu --</option>';
      }
    }


    async function loadAllQuestions() {
      const selectedSubject = subjectSelector.value;
      if (!selectedSubject) return;

      statusEl.innerHTML = '<span class="loading-spinner"></span> ƒêang t·∫£i to√†n b·ªô c√¢u h·ªèi cho b·ªô ƒë·ªÅ...';
      
      try {
        const colRef = collection(db, COLLECTION_NAME);
        const subjectValueForQuery = Number(selectedSubject);
        if (isNaN(subjectValueForQuery)) throw new Error('M√£ M√¥n kh√¥ng ph·∫£i d·∫°ng s·ªë.');

        const q = query(colRef, where(MA_MON_FIELD_NAME, '==', subjectValueForQuery));
        const snapshot = await getDocs(q);

        if (snapshot.empty) {
          statusEl.textContent = `‚ùå Kh√¥ng t√¨m th·∫•y c√¢u h·ªèi cho M√£ M√¥n: ${selectedSubject}.`;
          allQuestionsForSubject = [];
          questionCard.style.display = 'none';
          return;
        }

        allQuestionsForSubject = snapshot.docs.map(doc => {
            const data = doc.data();
            return {
                id: doc.id,
                text: data[QUESTION_TEXT_FIELD] || 'Kh√¥ng c√≥ n·ªôi dung c√¢u h·ªèi.',
                options: {
                    A: data[OPTION_A_FIELD] || 'ƒê√°p √°n A',
                    B: data[OPTION_B_FIELD] || 'ƒê√°p √°n B',
                    C: data[OPTION_C_FIELD] || 'ƒê√°p √°n C',
                    D: data[OPTION_D_FIELD] || 'ƒê√°p √°n D',
                },
                correctAnswer: String(data[CORRECT_ANSWER_FIELD] || '')
                               .toUpperCase()
                               .replace(/[^ABCD]/g, '')
                               .split('')
                               .sort()
                               .join(''),
                note: data[NOTE_FIELD] || null,
                selected: null, 
                answered: false 
            };
        });
        
        // Kh·ªüi t·∫°o tr·∫°ng th√°i m·ªõi
        historyStack = [];
        currentHistoryIndex = -1;
        isAnswered = false;
        
        // RESET V√Ä C·∫¨P NH·∫¨T TH·ªêNG K√ä
        stats = { correct: 0, incorrect: 0, totalAnswered: 0 };
        updateStatsDisplay();

        statusEl.textContent = `‚úÖ ƒê√£ t·∫£i ${allQuestionsForSubject.length} c√¢u h·ªèi. B·∫Øt ƒë·∫ßu luy·ªán t·∫≠p.`;
        questionCard.style.display = 'block';

        const subjectName = getSubjectName(selectedSubject);
        subjectNameDisplay.textContent = `üìö M√¥n: ${subjectName}`;
        
        loadNextQuestion(true); 

      } catch (error) {
        console.error("L·ªói khi t·∫£i c√¢u h·ªèi:", error);
        statusEl.textContent = '‚ùå L·ªói khi t·∫£i b·ªô ƒë·ªÅ: ' + error.message;
        questionCard.style.display = 'none';
      }
    }

    // -----------------------------------------------------
    // PH·∫¶N 2: ƒêI·ªÄU H∆Ø·ªöNG V√Ä HI·ªÇN TH·ªä
    // -----------------------------------------------------

    function getRandomQuestion() {
        if (allQuestionsForSubject.length === 0) return null;
        const randomIndex = Math.floor(Math.random() * allQuestionsForSubject.length);
        return allQuestionsForSubject[randomIndex];
    }

    function loadNextQuestion(isInitial = false) {
        if (allQuestionsForSubject.length === 0) return;

        if (currentHistoryIndex >= 0 && historyStack[currentHistoryIndex].answered === false) {
            saveCurrentSelection();
        }

        let nextQuestion;
        
        if (currentHistoryIndex < historyStack.length - 1) {
             currentHistoryIndex++;
             nextQuestion = historyStack[currentHistoryIndex];
        } else {
             if (historyStack.length >= HISTORY_LIMIT) {
                 historyStack = historyStack.slice(historyStack.length - HISTORY_LIMIT + 1);
                 currentHistoryIndex = historyStack.length - 1; 
             }
             
             nextQuestion = getRandomQuestion();
             historyStack.push(nextQuestion);
             currentHistoryIndex = historyStack.length - 1;
        }

        renderSingleQuestion(nextQuestion, isInitial);
        updateNavigationButtons();
    }

    function loadPreviousQuestion() {
        if (currentHistoryIndex > 0) {
            saveCurrentSelection(); 

            currentHistoryIndex--;
            const prevQuestion = historyStack[currentHistoryIndex];
            renderSingleQuestion(prevQuestion);
            updateNavigationButtons();
        }
    }
    
    function saveCurrentSelection() {
        const currentQuestion = historyStack[currentHistoryIndex];
        if (!currentQuestion) return;
        
        const selectedCheckboxes = Array.from(document.querySelectorAll('input[name="current_q"]:checked'));
        
        currentQuestion.selected = selectedCheckboxes.map(cb => cb.value).sort().join('');
        currentQuestion.answered = isAnswered;
    }

    function updateNavigationButtons() {
        prevBtn.classList.toggle('limit', currentHistoryIndex <= 0);
        answerBtn.disabled = isAnswered;
    }

    function updateStatsDisplay() {
        const total = stats.totalAnswered;
        const correct = stats.correct;
        const incorrect = stats.incorrect;
        
        statsDisplay.innerHTML = `
            üìä **Th·ªëng k√™:** ƒê√£ tr·∫£ l·ªùi: ${total} c√¢u | 
            ƒê√∫ng: <span style="color:#065f46;">${correct}</span> | 
            Sai: <span style="color:#9a3412;">${incorrect}</span>
        `;
    }

    function renderSingleQuestion(q) {
        isAnswered = q.answered || false; 
        feedbackEl.style.display = 'none';
        
        const questionHtml = `
            <div class="question-text">${q.text}</div> 
            
            <label class="answer-option" data-option="A">
                <input type="checkbox" name="current_q" value="A" ${q.selected && q.selected.includes('A') ? 'checked' : ''} ${isAnswered ? 'disabled' : ''}> 
                <span>A. ${q.options.A}</span>
            </label>
            
            <label class="answer-option" data-option="B">
                <input type="checkbox" name="current_q" value="B" ${q.selected && q.selected.includes('B') ? 'checked' : ''} ${isAnswered ? 'disabled' : ''}> 
                <span>B. ${q.options.B}</span>
            </label>
            
            <label class="answer-option" data-option="C">
                <input type="checkbox" name="current_q" value="C" ${q.selected && q.selected.includes('C') ? 'checked' : ''} ${isAnswered ? 'disabled' : ''}> 
                <span>C. ${q.options.C}</span>
            </label>
            
            <label class="answer-option" data-option="D">
                <input type="checkbox" name="current_q" value="D" ${q.selected && q.selected.includes('D') ? 'checked' : ''} ${isAnswered ? 'disabled' : ''}> 
                <span>D. ${q.options.D}</span>
            </label>
        `;
        questionContainer.innerHTML = questionHtml;
        answerBtn.disabled = isAnswered;

        updateStatsDisplay();

        if (isAnswered) {
            displayAnswerFeedback(q.selected, q.correctAnswer, q.note);
        }
    }

    // -----------------------------------------------------
    // PH·∫¶N 3: KI·ªÇM TRA ƒê√ÅP √ÅN V√Ä C·∫¨P NH·∫¨T TH·ªêNG K√ä
    // -----------------------------------------------------

    function checkAnswer() {
        if (isAnswered) return;
        
        const selectedCheckboxes = Array.from(document.querySelectorAll('input[name="current_q"]:checked'));
        
        if (selectedCheckboxes.length === 0) {
            alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt ƒë√°p √°n tr∆∞·ªõc khi tr·∫£ l·ªùi.');
            return;
        }

        const currentQuestion = historyStack[currentHistoryIndex];
        
        const selectedAnswer = selectedCheckboxes.map(cb => cb.value).sort().join('');
        const correctAnswer = currentQuestion.correctAnswer; 

        isAnswered = true;
        
        currentQuestion.answered = true; 
        currentQuestion.selected = selectedAnswer;

        document.querySelectorAll('input[name="current_q"]').forEach(cb => cb.disabled = true);
        
        if (selectedAnswer === correctAnswer) {
            stats.correct++;
        } else {
            stats.incorrect++;
        }
        stats.totalAnswered++;

        displayAnswerFeedback(selectedAnswer, correctAnswer, currentQuestion.note);
        updateStatsDisplay(); 
        updateNavigationButtons();
    }
    
    function displayAnswerFeedback(selectedAnswer, correctAnswer, note) {
        let feedbackHtml = '';
        feedbackEl.style.display = 'block';

        if (selectedAnswer === correctAnswer) {
            feedbackEl.className = 'feedback-correct';
            feedbackHtml += `üéâ **CH√çNH X√ÅC!** ƒê√°p √°n b·∫°n ch·ªçn (**${selectedAnswer}**) l√† ƒë√∫ng.`;
        } else {
            feedbackEl.className = 'feedback-incorrect';
            feedbackHtml += `‚ùå **SAI R·ªíI!** B·∫°n ch·ªçn (**${selectedAnswer}**). ƒê√°p √°n ƒë√∫ng l√† **${correctAnswer}**.`;
        }
        
        if (note) {
            feedbackHtml += `<div class="note-text">üìù **Ghi ch√∫:** ${note}</div>`;
        }
        
        feedbackEl.innerHTML = feedbackHtml;
    }

    // -----------------------------------------------------
    // PH·∫¶N 4: G√ÅN S·ª∞ KI·ªÜN
    // -----------------------------------------------------

    window.onload = loadSubjects;
    
    loadQuestionsBtn.addEventListener('click', loadAllQuestions);
    prevBtn.addEventListener('click', loadPreviousQuestion);
    nextBtn.addEventListener('click', () => loadNextQuestion(false)); 
    answerBtn.addEventListener('click', checkAnswer);

  </script>
</body>
</html>
